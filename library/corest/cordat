#!/bin/env bash

set -e


## HELPER
function craine_reposi_checks() {

    git ls-remote --exit-code $1 > /dev/null 2>&1 
    if [ $? -eq 0 ]; then
        echo true
    else
        echo false
    fi
}

function craine_naming_checks() {
    if [[ -z $craine_name ]];then
        notifer_error "missing distro name parameter"   
    fi
}

function craine_linker_checks() {

    notifer_inform "check remote parameters"
    if [[ -z $craine_link ]];then
        notifer_error "missing gitrepo link parameter"   
    fi

    notifer_inform "check remote repository"
    if [[ $( craine_reposi_checks $craine_link ) == false ]];then
        notifer_error "gitrepo not exist or private access"
    else
        notifer_inform "gitrepo ready to cloned"
    fi

}

## PRESET 
function craine_preset_basics() {

    local target_preset="$craine_preset/default"
    local remote_preset="https://github.com/almuhdilkarim/presets.git"

    if [[ ! -d $target_preset ]]&&[[ $( craine_netter ) ]];then
        notifer_inform "check default preset directory"
        git clone $remote_preset $target_preset > /dev/null 2>&1 
        notifer_inform "default preset directory ready"
    elif [[ ! -d $target_preset ]]; then
        notifer_error "Connection error, please connect network for the first session"
    fi
}

function craine_preset_remote() {

    if [[ $(craine_netter) == false ]];then
        notifer_warner "network connection fail" && exit 0
    fi

    ## notify
    notifer_inform "check preset remote resource"


    ## source
    local remote_dialog=$(notifer_inform "Do yout want replace with default preset : [y/N] ")
    local remote_source="https://github.com/almuhdilkarim/presets.git" 
    preset_remot_source=""


    ## option
    local custom_base=$( craine_reposi_checks $craine_link ) 
    local github_base=$( craine_reposi_checks "https://github.com/linux-$craine_base/presets" )
    local locals_base=$( craine_reposi_checks "https://rogers.git/linux-$craine_base/presets" )
    local github_name=$( craine_reposi_checks "https://github.com/linux-$craine_name/presets" )
    local locals_name=$( craine_reposi_checks "https://rogers.git/linux-$craine_name/presets" )


    ## valids
    if [[ $custom_base == true ]];then
        preset_remote_source=$craine_link
    elif [[ $locals_base == true ]];then
        preset_remote_source="https://rogers.git/linux-$craine_base/presets"
    elif [[ $locals_name == true ]];then
        preset_remote_source="https://rogers.git/linux-$craine_name/presets"
    elif [[ $github_base == true ]];then
        preset_remote_source="https://github.com/linux-$craine_base/presets"
    elif [[ $github_name == true ]];then
        preset_remote_source="https://github.com/linux-$craine_name/presets"
    fi

    ## default
    if [[ -z $preset_remote_source ]];then
        notifer_warner "Your remote resource preset does not exist"
        read -p "${remote_dialog}" remote_presets
    fi

    if [[ -n $remote_presets ]]&&[[ $remote_presets == "Y" ]]||[[ $remote_presets == "y" ]];then
        preset_remote_source=$remote_source &&
        notifer_inform "using default preset config"
    elif [[ -n $remote_presets ]];then
        notifer_warner "preset build canceled" && exit 0
    fi
}

function craine_preset_locals() {

    local local_options=""
    preset_local_folder="$craine_preset/$craine_name"
    local local_dialogs=$(notifer_inform "Do you want override local presets : [y/N] ")

    if [[ -d "$preset_local_folder" ]]; then
        notifer_warner "Local preset with name $craine_name already exist."
        read -p "${local_dialogs} " local_options
    fi

    if [[ -n $local_options ]]&&[[ $local_options == "Y" ]]||[[ $local_options == "y" ]]; then
        rm -fr $preset_local_folder &&
        notifer_inform "clean local preset directory"
    elif [[ -n $local_options ]]; then
        notifer_warner "preset install cancel" && exit 0
    fi
}

function craine_preset_create() {
    echo "preset create"
}

function craine_preset_clones() {

    craine_naming_checks
    craine_preset_locals
    craine_preset_remote
    local target_preset="$craine_preset/default"

    # clone information
    notifer_inform "remote repo: $preset_remot_source"
    notifer_inform "locals repo: $preset_local_folder"

    if [[ $(craine_netter) == true ]];then
        git clone $preset_remote_source $preset_local_folder > /dev/null 2>&1 
       
    elif [[ -d $target_preset ]];then
        cp -fr $target_preset $preset_local_folder

    else
        notifer_warner "default preset not existed" && exit 0
    fi
    
    notifer_inform "$craine_name preset installed"
}

function craine_preset_update() {

    craine_naming_checks

    ## target
    local target_preset="$craine_preset/$craine_name"

 
    if [[ -d $target_preset ]]; then

        notifer_inform "checking github resource"
        local github=$(cat "$target_preset/envi" | grep "gitrepo_github" | grep -o '"[^"]*"' | sed 's/"//g')
        notifer_inform "checking gitlab resource"
        local gitlab=$(cat "$target_preset/envi" | grep "gitrepo_gitlab" | grep -o '"[^"]*"' | sed 's/"//g')
        notifer_inform "checking custom resource"
        local gitloc=$(cat "$target_preset/envi" | grep "gitrepo_gitloc" | grep -o '"[^"]*"' | sed 's/"//g')

    else
        notifer_error "Update preset failed, preset does not exist"
    fi


    if [[ $( craine_reposi_checks $github ) ]];then

        notifer_inform "cleaning locals resource"
        rm -fr $target_preset &&
        notifer_inform "updating github resource"
        git clone $github $target_preset > /dev/null 2>&1 
        notifer_inform "preset is already update"

    elif [[ $( craine_reposi_checks $gitlab ) ]];then

        notifer_inform "cleaning locals resource"
        rm -fr $target_preset &&
        notifer_inform "updating gitlab resource"
        git clone $gitlab $target_preset > /dev/null 2>&1
        notifer_inform "preset is already update"

    elif [[ $( craine_reposi_checks $gitloc ) ]];then

        notifer_inform "cleaning locals resource"
        rm -fr $target_preset &&
        notifer_inform "updating custom resource"
        git clone $gitloc $target_preset > /dev/null 2>&1
        notifer_inform "preset is already update"

    else
        notifer_error "This preset is local, fail download from resource"
    fi

}

function craine_preset_delete() {

    craine_naming_checks

    echo "preset delete"
}

function craine_preset_upgrad() {

    for preset in $craine_preset/*; do
        if [[ -d $preset ]];then

            local presetname=$(basename "$preset")
            notifer_inform "prepare update $presetname preset"
            cd $preset && git pull > /dev/null 2>&1 
            notifer_inform "$presetname preset already update"
        fi
    done
}

function craine_preset() {

    if [[ -z $craine_mode ]];then
        notifer_error "Missing operation mode params"   
    fi

    if [[ $craine_mode == "clone" ]];then
        craine_preset_clones
    fi

    if [[ $craine_mode == "create" ]];then
        craine_preset_create
    fi

    if [[ $craine_mode == "update" ]];then
        craine_preset_update
    fi

    if [[ $craine_mode == "delete" ]];then
        craine_preset_delete
    fi

    if [[ $craine_mode == "upgrade" ]];then
        craine_preset_upgrad
    fi
}


## PROSET 
function craine_proset_basics() {

    notifer_inform "checking proset repository"
    if [[ ! -d $craine_proset ]];then
        git clone https://github.com/almuhdilkarim/proset.git $craine_proset
    fi
    notifer_inform "proset repository is ready"
}

function craine_proset_create() {
    echo "proset create"
}

function craine_proset_clones() {
    echo "proset clones"
}

function craine_proset_delete() {
    echo "proset delete"
}

function craine_proset_update() {

    if [[ $(craine_netter) == false ]];then
        notifer_warner "network connection fail" && exit 0
    fi

    if [[ -d $craine_proset ]];then
        rm -fr $craine_proset &&
        notifer_inform "cleaning proset repository"
    fi

    notifer_inform "updating proset repository"
    git clone https://github.com/almuhdilkarim/proset.git $craine_proset > /dev/null 2>&1 
    notifer_inform "proset directory is update"

}

function craine_proset_upgrad() {
    echo "proset create"
}

function craine_proset() {

    if [[ $1 == "clone" ]];then
        craine_proset_clones
    fi

    if [[ $1 == "create" ]];then
        craine_proset_create
    fi

    if [[ $1 == "update" ]];then
        craine_proset_update
    fi

    if [[ $1 == "delete" ]];then
        craine_proset_delete
    fi

    if [[ $1 == "upgrade" ]];then
        craine_proset_upgrad
    fi
}


## PROTOS
function craine_protos_basics() {

    local target_preset="$craine_protos/default"
    local remote_preset="https://github.com/almuhdilkarim/protos.git"

    if [[ ! -d $target_preset ]]&&[[ $( craine_netter ) ]];then
        notifer_inform "check default protos directory"
        git clone $remote_preset $target_preset > /dev/null 2>&1 
        notifer_inform "default protos directory ready"
    elif [[ ! -d $target_preset ]]; then
        notifer_error "Connection error, please connect network for the first session"
    fi
}

function craine_protos_delete() {

    craine_naming_checks

    echo "delete protocol"
}

function craine_protos_update() {

    local custom_protos="$craine_protos/$craine_name/$craine_pitc"

    if [[ -d $custom_protos ]];then
        notifer_inform "prepare update $craine_name level $craine_pitc"
        cd $custom_protos && git pull > /dev/null 2>&1 
        notifer_inform "$craine_name level $craine_pitc already update"
    else
        notifer_error "protos does not exist"
    fi
}

function craine_protos_create() {
    echo "protos create"
}

function craine_protos_clones() {
    
    craine_linker_checks
    
    local random_number=$(( ( RANDOM % 900000 ) + 100000 ))
    local target_random="$craine_protos/$random_number"
    local protos_dialog=$(notifer_inform "Do yout want replace existing protos : [y/N] ")

    notifer_inform "prepare protos installation"
    git clone $craine_link $target_random > /dev/null 2>&1 
    notifer_inform "protos install successfully"


    notifer_inform "checking protos metadata"
    local groups=$(cat "$target_random/envi" | grep "protocol_groups" | grep -o '"[^"]*"' | sed 's/"//g')
    local levels=$(cat "$target_random/envi" | grep "protocol_levels" | grep -o '"[^"]*"' | sed 's/"//g')
    local target="$craine_protos/$groups/$levels"


    if [[ -d $target ]];then
        notifer_warner "Local protos with name $groups already exist."
        read -p "${protos_dialog} " local_options
    fi

    if [[ -n $local_options ]]&&[[ $local_options == "Y" ]]||[[ $local_options == "y" ]]; then
        rm -fr $target &&
        notifer_inform "clean local protos directory"
    elif [[ -n $local_options ]]; then
        notifer_error "protos $groups level $levels is already exist"
    fi

    notifer_inform "installing $groups protos"
    mkdir -p $craine_protos/$groups &&
    mv -f $target_random $target &&
    notifer_inform "$groups protos installed"
}

function craine_protos_upgrad() {

    for groups in $craine_protos/*; do 
        for levels in $craine_protos/$groups/*; do 
            if [[ -d $levels ]];then
                local protosname=$(basename "$levels")
                notifer_inform "prepare update $groups level $protosname"
                cd $protos && git pull > /dev/null 2>&1 
                notifer_inform "$groups level $protosname already update"
            fi
        done
    done
}

function craine_protos() {

    if [[ -z $craine_mode ]];then
        notifer_error "missing operation mode params"   
    fi

    if [[ $craine_mode == "clone" ]];then
        craine_protos_clones
    fi

    if [[ $craine_mode == "create" ]];then
        craine_protos_create
    fi

    if [[ $craine_mode == "delete" ]];then
        craine_protos_delete
    fi

    if [[ $craine_mode == "update" ]];then
        craine_protos_update
    fi

    if [[ $craine_mode == "upgrade" ]];then
        craine_protos_upgrad
    fi
}