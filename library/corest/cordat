#!/bin/env bash

set -e


## PRESET 
function craine_preset_basics() {

    local target_preset="$craine_preset/default"
    local remote_preset="https://github.com/almuhdilkarim/presets.git"

    if [[ ! -d $target_preset ]]&&[[ $( craine_varinet_exist ) == true ]];then
        notifer_inform "check default preset directory"
        craine_gitrepo_clone $remote_preset $target_preset
        notifer_inform "default preset directory ready"
    elif [[ ! -d $target_preset ]]; then
        notifer_error "Connection error, please connect network for the first session"
    fi

    unset target_preset
    unset remote_preset
}

function craine_preset_clones() {

    if [[ $(craine_varrepo_exist) != true ]] ;then
        notifer_error "remote preset does not existed"
    fi


    local random_number=$(( ( RANDOM % 900000 ) + 100000 ))
    local target_random="$craine_preset/$random_number"

    notifer_inform "download remote repository data" &&
    craine_gitrepo_clone $craine_link $target_random &&
    notifer_inform "remote repoisitory is installed" && 


    notifer_inform "parsing current preset metadata"
    local preset_naming=$(cat "$target_random/envi" | grep "preset_uniq" | grep -o '"[^"]*"' | sed 's/"//g')
    local preset_target="$craine_preset/$preset_naming"


    if [[ ! -d $preset_target ]];then
        mv -f $target_random $preset_target
        notifer_inform "preset installation successfull"
    else
        rm -fr $target_random &&
        notifer_error "$craine_name preset existed"
    fi


    unset preset_naming
    unset preset_target
    unset random_number
    unset target_random
}

function craine_preset_puller() {

    craine_varname_noval

    local target_preset="$craine_preset/$craine_name"

    if [[ -d $target_preset ]];then

        notifer_inform "checking remote preset resource"
        craine_gitrepo_pulls $target_preset 
        notifer_inform "locals preset is already update"

    else
        notifer_error "Update preset failed, preset does not exist"
    fi

    unset target_preset
}

function craine_preset_pusher() {

    craine_varname_noval

    local target_preset="$craine_preset/$craine_name"


    if [[ -d $target_preset ]];then

        notifer_inform "checking remote preset resource"
        craine_gitrepo_pushs $target_preset 
        notifer_inform "remote preset is already update"

    else
        notifer_error "Update preset failed, remote preset does not exist"
    fi

    unset target_preset
}

function craine_preset_syncro() {


    local preset_naming=${craine_name^}
    local preset_unique=${craine_name,,}
    local target_source=$1
    local config_source=$1/conf/usr/lib/os-release


    notifer_inform "distros presets synchronization"
    sed -i '7d' "$target_source/envi" &&
    sed -i '7i\preset_repo="'$craine_link'"' "$target_source/envi" &&
    sed -i "s/"DefaultOS"/$preset_naming/g" "$target_source/envi"  &&
    sed -i "s/"defaultos"/$preset_unique/g" "$target_source/envi" 


    notifer_inform "distros release synchronization"
    sed -i "s/"distrouniq"/$preset_unique/g" "$config_source" &&
    sed -i "s/"DISTRONAME"/$preset_naming/g" "$config_source" 


    unset preset_naming
    unset preset_unique
    unset target_source
    unset config_source
}

function craine_preset_create() {

    craine_varname_noval


    local preset_unique=${craine_name,,}
    local locals_source="$craine_preset/default"
    local target_source="$craine_preset/$preset_unique"
    local remote_source=$craine_link


    craine_vardirs_exist $target_source


    if [[ $(craine_varinet_exist) == true ]]&&[[ $(craine_varrepo_exist) == true ]] ;then


        notifer_inform "cloning source from remote data" &&
        craine_gitrepo_clone $craine_link $target_source &&

        notifer_inform "prepare sources for preset data" &&
        cp -fr $locals_source/* $target_source

        notifer_inform "synchronizing local preset data" &&
        craine_preset_syncro $target_source &&

        notifer_inform "synchronizing preset to remotes" &&
        craine_gitrepo_pushs $target_source
        notifer_inform "remote preset build succesfully" 


    elif [[ -d $locals_source ]];then


        notifer_inform "creating local preset directory" &&
        cp -fr $locals_source $target_source &&

        notifer_inform "synchronizing local preset data" &&
        craine_preset_syncro $target_source &&

        notifer_inform "pure remote data configurations" &&
        rm -fr $target_source/.git
        notifer_inform "locals preset build succesfully" 
    

    else

        notifer_error "default preset not existed"

    fi


    unset preset_unique
    unset locals_source
    unset target_source    
}

function craine_preset_resets() {

    craine_varname_noval

    local locals_source="$craine_preset/default"
    local target_source="$craine_preset/$craine_name"


    for preset_target in $target_source/*; do

        if [[ -d $preset_target ]];then

            local preset_naming=$(basename "$preset_target")

            notifer_inform "removed preset module $preset_naming"
            rm -fr $preset_target

            notifer_inform "install preset module $preset_naming"
            cp -fr $locals_source/$preset_naming $preset_target
        fi
    done

    notifer_inform "checking remote preset resource"
    craine_gitrepo_pushs $target_source &&
    notifer_inform "preset module reset succesfully"


    unset preset_naming
    unset preset_target
    unset locals_source
    unset target_source
}

function craine_preset_delete() {


    craine_varname_noval
   

    local preset_naming=${craine_name,,}
    local target_source="$craine_preset/$preset_naming"


    craine_vardirs_noval $target_source


    local remote_source=$(cat "$target_source/envi" | grep "preset_repo" | grep -o '"[^"]*"' | sed 's/"//g')


    if [[ -n $remote_source ]];then

        notifer_inform "removing presets data on locals" &&
        for preset_target in $target_source/*; do
            test -d $preset_target && rm -fr $preset_target
        done

        rm $target_source/envi

        notifer_inform "removing presets data at remote" &&
        craine_gitrepo_pushs $target_source
    fi
    
    test -d $target_source && rm -fr $target_source

    unset preset_target
    unset preset_naming
    unset target_source
    unset remote_source
}

function craine_preset_upgrad() {

    for preset_target in $craine_preset/*; do
        if [[ -d $preset_target ]];then

            local preset_naming=$(basename "$preset_target")
            notifer_inform "prepare update $preset_naming preset"
            craine_gitrepo_pulls $preset_target
            notifer_inform "$preset_naming preset already update"
        fi
    done

    unset $preset_target
    unset $preset_naming
}

function craine_preset() {

    if [[ -z $craine_mode ]];then
        notifer_error "Missing operation mode params"   
    fi

    if [[ $craine_mode == "push" ]];then
        craine_preset_pusher
    fi

    if [[ $craine_mode == "pull" ]];then
        craine_preset_puller
    fi

    if [[ $craine_mode == "clone" ]];then
        craine_preset_clones
    fi

    if [[ $craine_mode == "reset" ]];then
        craine_preset_resets
    fi

    if [[ $craine_mode == "create" ]];then
        craine_preset_create
    fi

    if [[ $craine_mode == "delete" ]];then
        craine_preset_delete
    fi

    if [[ $craine_mode == "upgrade" ]];then
        craine_preset_upgrad
    fi
}


## PROSET 
function craine_proset_basics() {

    local target_proset="$craine_proset/default"
    local remote_proset="https://github.com/almuhdilkarim/proset.git"

    if [[ ! -d $target_proset ]]&&[[ $( craine_varinet_exist ) == true ]];then
        notifer_inform "check default proset directory"
        craine_gitrepo_clone $remote_proset $target_proset
        notifer_inform "default proset directory ready"
    elif [[ ! -d $target_proset ]]; then
        notifer_error "Connection error, please connect network for the first session"
    fi

    unset target_proset
    unset remote_proset

}

function craine_proset_clones() {


    if [[ $(craine_varrepo_exist) != true ]] ;then
        notifer_error "remote proset does not existed"
    fi


    local random_number=$(( ( RANDOM % 900000 ) + 100000 ))
    local target_random="$craine_proset/$random_number"

    notifer_inform "download remote repository data" &&
    craine_gitrepo_clone $craine_link $target_random &&
    notifer_inform "remote repoisitory is installed" && 


    notifer_inform "parsing current proset metadata"
    local proset_naming=$(cat "$target_random/envi" | grep "proset_name" | grep -o '"[^"]*"' | sed 's/"//g')
    local proset_target="$craine_proset/$proset_naming"


    if [[ ! -d $proset_target ]];then
        mv -f $target_random $proset_target
        notifer_inform "proset installation successfull"
    else
        rm -fr $target_random &&
        notifer_error "$craine_name proset existed"
    fi


    unset proset_naming
    unset proset_target
    unset random_number
    unset target_random
}

function craine_proset_puller() {

    craine_varname_noval

    local target_proset="$craine_proset/$craine_name"

    if [[ -d $target_proset ]];then

        notifer_inform "checking remote proset resource"
        craine_gitrepo_pulls $target_proset 
        notifer_inform "locals proset is already update"

    else
        notifer_error "Update proset failed, proset does not exist"
    fi

    unset target_proset
}

function craine_proset_pusher() {


    craine_varname_noval


    local target_proset="$craine_proset/$craine_name"


    if [[ -d $target_proset ]];then

        notifer_inform "checking remote proset resource"
        craine_gitrepo_pushs $target_proset 
        notifer_inform "remote proset is already update"

    else
        notifer_error "Update proset failed, remote proset does not exist"
    fi

    unset target_proset
}

function craine_proset_syncro() {

    local config_source=$1/envi
    local proset_source=$craine_link
    local proset_author=${craine_auth,,}
    local protos_naming=${craine_name,,}


    echo 'proset_auth="'$proset_author'"' >  $config_source &&
    echo 'proset_name="'$protos_naming'"' >> $config_source &&
    echo 'proset_repo="'$proset_source'"' >> $config_source &&


    unset config_source
    unset proset_source
    unset proset_author
    unset protos_naming
}

function craine_proset_create() {

    craine_varauth_noval
    craine_varname_noval
    

    local proset_naming=${craine_name,,}
    local locals_source="$craine_proset/default"
    local target_source="$craine_proset/$proset_naming"
    local remote_source=$craine_link

    craine_vardirs_exist $target_source


    if [[ $(craine_varinet_exist) == true ]]&&[[ $(craine_varrepo_exist) == true ]] ;then


        notifer_inform "cloning source from remote data" &&
        craine_gitrepo_clone $craine_link $target_source &&

        notifer_inform "prepare sources for proset data" &&
        rm -fr $target_source/*
        cp -fr $locals_source/* $target_source

        notifer_inform "synchronizing local proset data" &&
        craine_proset_syncro $target_source &&

        notifer_inform "synchronizing proset to remotes" &&
        craine_gitrepo_pushs $target_source
        notifer_inform "remote proset build succesfully" 


    elif [[ -d $locals_source ]];then


        notifer_inform "creating local proset directory" &&
        cp -fr $locals_source $target_source &&

        notifer_inform "synchronizing local proset data" &&
        craine_proset_syncro $target_source &&

        notifer_inform "pure remote data configurations" &&
        rm -fr $target_source/.git
        notifer_inform "locals proset build succesfully" 
    

    else

        notifer_error "default proset not existed"

    fi


    unset proset_naming
    unset locals_source
    unset target_source    
}

function craine_proset_resets() {

    craine_varname_noval

    local locals_source="$craine_proset/default/config"
    local target_source="$craine_proset/$craine_name"


    rm -fr $target_source/config
    cp -fr $locals_source $target_source

    notifer_inform "checking remote proset resource"
    craine_gitrepo_pushs $target_source &&
    notifer_inform "proset module reset succesfully"


    unset locals_source
    unset target_source
}

function craine_proset_delete() {

    craine_varname_noval
   

    local proset_naming=${craine_name,,}
    local target_source="$craine_proset/$proset_naming"


    craine_vardirs_noval $target_source


    local remote_source=$(cat "$target_source/envi" | grep "proset_repo" | grep -o '"[^"]*"' | sed 's/"//g')


    if [[ -n $remote_source ]];then

        notifer_inform "removing prosets data on locals" &&
        for proset_target in $target_source/*; do
            test -d $proset_target && rm -fr $proset_target
        done

        rm $target_source/envi

        notifer_inform "removing prosets data at remote" &&
        craine_gitrepo_pushs $target_source
    fi
    
    test -d $target_source && rm -fr $target_source

    unset proset_target
    unset proset_naming
    unset target_source
    unset remote_source
}

function craine_proset_upgrad() {
    
    for proset_target in $craine_proset/*; do
        if [[ -d $proset_target ]];then

            local proset_naming=$(basename "$proset_target")
            notifer_inform "prepare update $proset_naming proset"
            craine_gitrepo_pulls $proset_target
            notifer_inform "$proset_naming proset already update"
        fi
    done

    unset $proset_target
    unset $proset_naming
}

function craine_proset() {

    if [[ -z $craine_mode ]];then
        notifer_error "missing operation mode params"   
    fi

    if [[ $craine_mode == "pull" ]];then
        craine_proset_puller
    fi

    if [[ $craine_mode == "push" ]];then
        craine_proset_pusher
    fi

    if [[ $craine_mode == "clone" ]];then
        craine_proset_clones
    fi

    if [[ $craine_mode == "reset" ]];then
        craine_proset_resets
    fi

    if [[ $craine_mode == "create" ]];then
        craine_proset_create
    fi

    if [[ $craine_mode == "delete" ]];then
        craine_proset_delete
    fi

    if [[ $craine_mode == "upgrade" ]];then
        craine_proset_upgrad
    fi
}


## PROTOS
function craine_protos_basics() {


    local target_protos="$craine_protos/default"
    local remote_protos="https://github.com/almuhdilkarim/protos.git"


    if [[ ! -d $target_protos ]]&&[[ $( craine_varinet_exist ) == true ]];then
        notifer_inform "check default protos directory"
        craine_gitrepo_clone $remote_protos $target_protos
        notifer_inform "default protos directory ready"
    elif [[ ! -d $target_protos ]]; then
        notifer_error "Connection error, please connect network for the first session"
    fi

    unset target_protos
    unset remote_protos
}

function craine_protos_clones() {
    
    if [[ $(craine_varrepo_exist) != true ]] ;then
        notifer_error "remote protos does not existed"
    fi
    

    local random_number=$(( ( RANDOM % 900000 ) + 100000 ))
    local target_random="$craine_protos/$random_number"


    notifer_inform "download remote repository data" &&
    craine_gitrepo_clone $craine_link $target_random &&
    notifer_inform "remote repoisitory is installed" && 


    notifer_inform "parsing current protos metadata"
    local protos_groups=$(cat "$target_random/envi" | grep "protos_base" | grep -o '"[^"]*"' | sed 's/"//g')
    local protos_naming=$(cat "$target_random/envi" | grep "protos_name" | grep -o '"[^"]*"' | sed 's/"//g')
    local locals_target="$craine_protos/$groups/$naming"


    if [[ ! -d $locals_target ]];then
        mkdir -p "$craine_protos/$groups"
        mv -f $target_random $locals_target
        notifer_inform "protos installation successfull"
    else
        rm -fr $target_random &&
        notifer_error "protos $groups with name $naming existed"
    fi


    unset protos_groups
    unset protos_naming
    unset locals_target
    unset random_number
    unset target_random
}

function craine_protos_puller() {

    craine_varname_noval
    craine_varbase_noval

    local target_protos="$craine_protos/$craine_base/$craine_name"

    if [[ -d $target_protos ]];then

        notifer_inform "checking remote protos resource"
        craine_gitrepo_pulls $target_protos 
        notifer_inform "locals protos is already update"

    else
        notifer_error "Update protos failed, protos does not exist"
    fi

    unset target_protos
}

function craine_protos_pusher() {

    craine_varname_noval
    craine_varbase_noval

    local target_protos="$craine_protos/$craine_base/$craine_name"

    if [[ -d $target_protos ]];then

        notifer_inform "checking remote protos resource"
        craine_gitrepo_pushs $target_protos
        notifer_inform "remote protos is already update"

    else
        notifer_error "Update protos failed, protos does not exist"
    fi

    unset target_protos
}

function craine_protos_syncro() {
    
    local config_source=$1/envi
    local protos_source=$craine_link
    local protos_author=${craine_auth,,}
    local protos_groups=${craine_base,,}
    local protos_naming=${craine_name,,}

    echo 'protos_auth="'$protos_author'"' >  $config_source &&
    echo 'protos_base="'$protos_groups'"' >> $config_source &&
    echo 'protos_name="'$protos_naming'"' >> $config_source &&
    echo 'protos_repo="'$protos_source'"' >> $config_source &&

    unset config_source
    unset protos_source
    unset protos_naming
    unset protos_groups
    unset protos_naming
}

function craine_protos_create() {

    craine_varauth_noval
    craine_varbase_noval
    craine_varname_noval


    local protos_source=$craine_link
    local protos_author=${craine_auth,,}
    local protos_groups=${craine_base,,}
    local protos_naming=${craine_name,,}
    local locals_source="$craine_protos/default"
    local target_source="$craine_protos/$protos_groups/$protos_naming"


    craine_vardirs_exist $target_source


    if [[ $(craine_varinet_exist) == true ]]&&[[ $(craine_varrepo_exist) == true ]] ;then

        notifer_inform "cloning source from remote data" &&
        craine_gitrepo_clone $protos_source $target_source &&

        notifer_inform "prepare sources for protos data" &&
        cp -fr $locals_source/* $target_source

        notifer_inform "synchronizing local protos data" &&
        craine_protos_syncro $target_source &&

        notifer_inform "synchronizing protos to remotes" 
        craine_gitrepo_pushs $target_source

    elif [[ -d $locals_source ]];then

        notifer_inform "creating local protos directory" &&
        cp -fr $locals_source $target_source &&

        notifer_inform "synchronizing local protos data" &&
        craine_protos_syncro $target_source &&

        notifer_inform "pure remote data configurations" &&
        rm -fr $target_source/.git
    
    else

        notifer_error "default protos not existed"
    fi


    unset protos_source
    unset protos_author
    unset protos_groups
    unset protos_naming
    unset locals_source
    unset target_source

    notifer_inform "distro protos build succesfully" 
}

function craine_protos_resets() {
    
    craine_varbase_noval
    craine_varname_noval

    local locals_source="$craine_protos/default"
    local target_source="$craine_protos/$craine_base/$craine_name"

    
    craine_vardirs_exist $target_source


    for protos_target in $target_source/*; do 
    
        if [[ -d $protos_target ]];then

            local protos_naming=$(basename "$protos_target")

            notifer_inform "removed group $craine_base name $protos_naming"
            rm -fr $protos_target

            notifer_inform "install group $craine_base name $protos_naming"
            cp -fr $locals_source/$protos_naming $protos_target
        fi
    done

    notifer_inform "checking remote protos resource"
    craine_gitrepo_pushs $target_source &&
    notifer_inform "locals protos is already update"

    unset protos_naming
    unset protos_target
    unset locals_source
    unset target_source
}

function craine_protos_delete() {

    craine_varbase_noval
    craine_varname_noval

    local protos_groups=${craine_base,,}
    local protos_naming=${craine_name,,}
    local target_source="$craine_protos/$protos_groups/$protos_naming"


    craine_vardirs_noval $target_source


    local remote_source=$(cat "$target_source/envi" | grep "protos_repo" | grep -o '"[^"]*"' | sed 's/"//g')


    if [[ -n $remote_source ]];then

        notifer_inform "removing protos data on locals" &&
        for protos_target in $target_source/*; do
            test -d $protos_target && rm -fr $protos_target
        done

        test -d $target_source/envi && rm $target_source/envi
        test -d $target_source/load && rm $target_source/load 

        notifer_inform "removing protos data at remote" &&
        craine_gitrepo_pushs $target_source
    fi
    
    test -d $target_source && rm -fr $target_source

    unset protos_target
    unset protos_groups
    unset protos_naming
    unset target_source
    unset remote_source
}

function craine_protos_upgrad() {

    for groups in $craine_protos/*; do 

        local protos_groups=$(basename "$groups")

        if [[ $protos_groups == "default" ]];then
            notifer_inform "prepare update $protos_groups baserepo"
            craine_gitrepo_pulls $groups && 
            notifer_inform "$protos_groups baserepo already update"
        fi

        if [[ $protos_groups != "default" ]];then
            for naming in $craine_protos/$protos_groups/*; do 
                if [[ -d $naming ]];then
                    local protos_naming=$(basename "$naming")
                    notifer_inform "prepare update $protos_groups level $protos_naming"
                    craine_gitrepo_pulls $naming && 
                    notifer_inform "$protos_groups level $protos_naming already update"
                fi
            done
        fi

    done
    
    unset groups
    unset naming
    unset protos_groups
    unset protos_naming

}

function craine_protos() {

    if [[ -z $craine_mode ]];then
        notifer_error "missing operation mode params"   
    fi

    if [[ $craine_mode == "pull" ]];then
        craine_protos_puller
    fi

    if [[ $craine_mode == "push" ]];then
        craine_protos_pusher
    fi

    if [[ $craine_mode == "clone" ]];then
        craine_protos_clones
    fi

    if [[ $craine_mode == "reset" ]];then
        craine_protos_resets
    fi

    if [[ $craine_mode == "create" ]];then
        craine_protos_create
    fi

    if [[ $craine_mode == "delete" ]];then
        craine_protos_delete
    fi

    if [[ $craine_mode == "upgrade" ]];then
        craine_protos_upgrad
    fi
}
