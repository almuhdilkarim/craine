#!/bin/bash

set -e 


## PREPARATION 
function craine_maker_paths() {


    local preset_name=${preset_name,,}

    # raptor target installation
    raptor_rooter="$initdir/$preset_name"
    raptor_auxele="$initdir/$preset_name/auxel"
    raptor_makers="$initdir/$preset_name/auxel/makes"
    raptor_resete="$initdir/$preset_name/auxel/resete"
    raptor_config="$initdir/$preset_name/auxel/config"
    raptor_packer="$initdir/$preset_name/auxel/packer/pacmir"
    raptor_packco="$initdir/$preset_name/auxel/packer/packco"
    raptor_packfa="$initdir/$preset_name/auxel/packer/packfa"
    

    ## prepare folder information   
    preset_folder="$apppath/preset/default"
    test -d "$apppath/preset/$preset_name" && preset_folder="$apppath/preset/$preset_name"
    test -d "$apppath/preset/$preset_base" && preset_folder="$apppath/preset/$preset_base"
    test -d "$preset_conf" && preset_folder="$preset_conf"


    ## preaprea default configure
    test -d "$preset_folder/profile" && preset_userde="$preset_folder/profile"
    test -e "$preset_folder/distro.conf" && preset_distro="$preset_folder/distro.conf"
    test -e "$preset_folder/librep.conf" && preset_gitrep="$preset_folder/librep.conf"
    test -e "$preset_folder/readme.conf" && preset_readme="$preset_folder/readme.conf"
    test -e "$preset_folder/licens.conf" && preset_licens="$preset_folder/readme.conf"
    test -e "$preset_folder/protos.conf" && source "$preset_folder/protos.conf"
  

    ## prepare distro buidlprofil
    test -d "$apppath/profile" && preset_profil="$apppath/profile"
}


## PREPGITREPO 
function craine_maker_repos() {

    local distro_repos="$initdir/$preset_name/auxel/datum/gitrepo.conf"
    local source_repos=$distro_gitrep
    test -n $preset_gitr && source_repos=$preset_gitr

    echo $source_repos

    ## create distro directory
    if [[ $inetcon == true ]]; then
       
        test -e "$raptor_rooter" && rm -fr "$raptor_rooter"
        git clone $source_repos $raptor_rooter
       
        if [ $? -eq 0 ]; then

            rm -fr "$raptor_rooter/"* && 
            mkdir -p "$initdir/$preset_name/auxel/datum/" && 
            echo $source_repos > $distro_repos 
            echo "git clone is successful"
        else
            echo "git clone is failed" && exit 1
        fi
    else
        test -d "$raptor_rooter" && rm -fr "$raptor_rooter" 
        mkdir -p "$raptor_rooter/auxel/datum/" && touch $distro_repos
        echo $source_repos > $distro_repos 
    fi
}


## PREPSYSBASE 
function craine_maker_cores() {

    ## prepare
    mkdir -p "$raptor_rooter/"{locals,relpre,auxel/profile} &&

    # coresys
    cp -fr "$appcore/"* "$raptor_rooter"  &&
    cp -fr "$appcore/."* "$raptor_rooter" &&

    
    # profile
    cp -fr "$preset_profil" "$raptor_rooter/distro" &&

    # installer
    mv "$raptor_rooter/install" "$raptor_rooter/installer"

    # readme
    cp $preset_readme $raptor_rooter/README.md

    # license
    cp $preset_licens $raptor_rooter/LICENSE

    # default installation profile
    cp -fr $preset_userde $raptor_auxele
}


function craine_maker_confi() {

    ## ENVIRONTMENT
    local distro_repos="$initdir/$preset_name/auxel/datum/raptors.conf"
    mkdir -p "$initdir/$preset_name/auxel/datum" &&
    cp $preset_distro "$initdir/$preset_name/auxel/datum/prep1" &&
    sed -i '1cdistro_naming="'${preset_name^}'"'  "$initdir/$preset_name/auxel/datum/prep1" &&
    sed -i '2cdistro_unique="'${preset_name,,}'"' "$initdir/$preset_name/auxel/datum/prep1" &&

    sed '/^[[:blank:]]*#/d' "$initdir/$preset_name/auxel/datum/prep1" > "$initdir/$preset_name/auxel/datum/prep2" &&
    sed '/^[[:space:]]*$/d' "$initdir/$preset_name/auxel/datum/prep2" > $distro_repos &&

    rm "$initdir/$preset_name/auxel/datum/prep1" &&
    rm "$initdir/$preset_name/auxel/datum/prep2"
}


function craine_maker_relea() {
    
    local osrelease="$initdir/$preset_name/auxel/release"

    if [[ ! -z "$distro_naming" ]];then
        echo 'NAME="'$distro_naming'"' > $osrelease
        echo 'PRETTY_NAME="'$distro_naming'"' >> $osrelease
    else
        echo 'NAME="Falcone OS"' > $osrelease
        echo 'PRETTY_NAME="Falcone OS"' >> $osrelease
    fi

    if [[ ! -z "$distro_unique" ]];then
        echo 'ID='$distro_unique'' >> $osrelease
    else
        echo 'ID=falcone' >> $osrelease
    fi

    echo 'ANSI_COLOR="38;2;23;147;209"' >> $osrelease

    if [[ -z "$distro_websit" ]];then
        echo 'HOME_URL="https://'$distro_unique'.yuros.org"' >> $osrelease
        
    else
        echo 'HOME_URL="'$distro_websit'"' >> $osrelease
    fi

    if [[ -z "$distro_docuse" ]];then
        echo 'DOCUMENTATION_URL="https://'$distro_unique'.yuros.org/docs"' >> $osrelease
    else
       echo 'DOCUMENTATION_URL="'$distro_docuse'"' >> $osrelease
    fi

    if [[ -z "$distro_forums" ]];then
        echo 'SUPPORT_URL="https://'$distro_unique'.yuros.org/forum"' >> $osrelease
    else
       echo 'SUPPORT_URL="'$distro_forums'"' >> $osrelease
    fi

    if [[ -z "$distro_report" ]];then
        echo 'BUG_REPORT_URL="https://'$distro_unique'.yuros.org/issues"' >> $osrelease
    else
       echo 'BUG_REPORT_URL="'$distro_report'"' >> $osrelease
    fi

    if [[ -z "$distro_privac" ]];then
        echo 'PRIVACY_POLICY_URL="https://'$distro_unique'.yuros.org/privacy"' >> $osrelease
    else
       echo 'PRIVACY_POLICY_URL="'$distro_privac'"' >> $osrelease
    fi

    if [[ ! -z "$distro_brands" ]];then
        echo 'LOGO='$distro_unique'-linux' >> $osrelease
    else
       echo 'LOGO=falcone-linux' >> $osrelease
    fi

    cat $osrelease > "$initdir/$preset_name/auxel/config/usr/lib/os-release"
    cat $osrelease > "$initdir/$preset_name/distro/airootfs/etc/os-release"
    rm  $osrelease
}


function craine_maker_genis() {

    sleep 1 &&

    local search_string="OSNAMEOS"
    local distro_string="$distro_naming"
    local geniso_gruber="$initdir/$preset_name/distro/grub"
    local geniso_syslin="$initdir/$preset_name/distro/syslinux"
    local geniso_efibot="$initdir/$preset_name/distro/efiboot/loader/entries"
    

    sed -i "s/$search_string/$distro_string/g" "$geniso_syslin/"*.cfg
    sed -i "s/$search_string/$distro_string/g" "$geniso_gruber/"*.cfg
    sed -i "s/$search_string/$distro_string/g" "$geniso_efibot/"*.conf


    sed -i "s/osnameid/$distro_unique/g" "$initdir/$preset_name/distro/profiledef.sh"
    sed -i "s/$search_string/$distro_string/g" "$initdir/$preset_name/distro/profiledef.sh"   
}


function craine_maker_envir() {

    source "$applibs/libfirm/load" &&
    source "$applibs/libkern/load" &&
    source "$applibs/libboot/load" &&
    source "$applibs/libdisk/load" &&
    source "$applibs/libnets/load" &&
    source "$applibs/libaudi/load" &&
    source "$applibs/libguis/load" &&
    source "$applibs/libsecs/load" &&
    source "$applibs/libcore/load" &&
    source "$applibs/libhids/load" &&
    source "$preset_folder/loader"
}


function craine_maker_based() {

    local distro_repos="$initdir/$preset_name/auxel/datum/raptors.conf"
    rm -f $distro_repos && touch $distro_repos

    craine_maker_cores &&
    craine_maker_confi &&
    craine_maker_relea &&
    craine_maker_genis &&
    craine_maker_envir 
}


## PREPSYSBASE 
function craine_maker_preps() {
    craine_write_prepmake $firms_path
    craine_write_prepmake $disks_path
    craine_write_prepmake $kerns_path
    craine_write_prepmake $boots_path
    craine_write_prepmake $neter_path
    craine_write_prepmake $audio_path
    craine_write_prepmake $deskt_path
    craine_write_prepmake $mitig_path
    craine_write_prepmake $secur_path
    craine_write_prepmake $distr_path
    craine_write_prepmake $cores_path   
}


function craine_maker_posts() {
    craine_write_postmake $firms_path
    craine_write_postmake $cores_path
    craine_write_postmake $disks_path
    craine_write_postmake $kerns_path
    craine_write_postmake $neter_path
    craine_write_postmake $audio_path
    craine_write_postmake $deskt_path
    craine_write_postmake $mitig_path
    craine_write_postmake $secur_path
    craine_write_postmake $distr_path
    craine_write_postmake $boots_path
    craine_write_donemake $cores_path
}


function craine_maker_doned() {
    cd $raptor_rooter &&
    git add . &&
    git commit -m "$(date)" &&
    git push
}


function craine_maker_proc() {
    craine_maker_paths &&
    craine_maker_repos &&
    craine_maker_based &&
    craine_maker_preps &&
    craine_maker_posts &&
    craine_maker_doned
}


function craine_maker() {

    name=$1
    gitr=$2
    base=$3
    conf=$4

    preset_conf=$conf
    preset_gitr=$gitr
    preset_name=${name,,}
    preset_base=${base,,}
    test -z $base && preset_base=${name,,}
    
    echo "Operating System Overview"
    echo "name : $preset_name"
    echo "repo : $preset_gitr"
    echo "base : $preset_base"
    echo "conf : $preset_conf"

    read -p "Build $preset_name Operating System : [Y/n] " buildosdevelkit

    if [[ $buildosdevelkit == "Y" ]];then
        craine_maker_proc
    else
        exit 0
    fi
}