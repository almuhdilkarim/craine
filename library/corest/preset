#!/bin/env bash
# Preset main process
set -e


function craine_preset_getenv() {

    craine_config_getval "$1"

    preset_naming=$( craine_string_allcap "$preset_spreading" )
    preset_sluger=$( craine_stringt_strip "$preset_spreading" )
    preset_unique=$( craine_stringt_strip "$preset_spreading" )
    preset_protos="$preset_protobase/$preset_protoname"
    preset_locals="$craine_preset/$preset_sluger"
    preset_proset="$preset_prosetvar"
    preset_remote="$preset_repo_base"
    preset_tester="$preset_repo_labs"
}

function craine_preset_setenv() {

    locals_source="$craine_preset/$craine_name"
    locals_enviro="$locals_source/envi"
    random_enviro="$preset_random/envi"
    remote_source="$craine_link"
}

function craine_preset_basics() {

    craine_varinet_noval

    local locals_source="$craine_preset/default"
    local remote_source="$craine_core_gitpreset"

    if [[ ! -d $locals_source ]];then
        craine_gitrepo_clone "$remote_source" "$locals_source"
    fi

    unset locals_source
    unset remote_source
}

function craine_preset_clones() {

    craine_varinet_noval
    craine_varrepo_noval

    craine_remote_clones "$remote_source" "$preset_random"
    craine_preset_getenv "$locals_source"
    craine_locals_movers $preset_random $preset_locals



    #local preset_naming=$(craine_basename_path)
    #local remote_source="$craine_link"
    #local locals_source="$craine_preset/$preset_naming"

    #test -d "$locals_source" && craine_loging_errors "$preset_naming preset is already exist"
    #craine_gitrepo_clone "$remote_source" "$locals_source"

    #unset remote_source
    #unset locals_source



}

function craine_preset_puller() {

    craine_varname_noval

    local locals_source="$craine_preset/$craine_name"

    craine_gitrepo_pulls "$locals_source"

    unset locals_source
}

function craine_preset_releas() {
    echo 'preset update major'
}

function craine_preset_update() {
    echo 'preset update feature'
}

function craine_preset_patchs() {
        
    craine_varname_noval
    craine_preset_setenv
    craine_preset_getenv "$locals_enviro"
    craine_gitrepo_patch "$locals_source"
}

function craine_preset_writer() {


    local preset_naming=${craine_name^}
    local preset_unique=${craine_name,,}
    local target_source=$1
    local config_source=$1/conf/usr/lib/os-release


    notifer_inform "distros presets synchronization"
    sed -i '7d' "$target_source/envi" &&
    sed -i '7i\preset_repo="'$craine_link'"' "$target_source/envi" &&
    sed -i "s/"DefaultOS"/$preset_naming/g" "$target_source/envi"  &&
    sed -i "s/"defaultos"/$preset_unique/g" "$target_source/envi" 


    notifer_inform "distros release synchronization"
    sed -i "s/"distrouniq"/$preset_unique/g" "$config_source" &&
    sed -i "s/"DISTRONAME"/$preset_naming/g" "$config_source" 


    unset preset_naming
    unset preset_unique
    unset target_source
    unset config_source
}

function craine_preset_editor() {
    test -f $1 && $EDITOR $1
}

function craine_preset_create() {

    craine_varname_noval
    craine_varpres_noval
    craine_preset_setenv
    
    echo "reach"
    
    if [[ $(craine_varinet_exist) == true ]];then
        craine_remote_clones "$craine_gitpre" "$preset_random"
    fi

    if [[ $(craine_varinet_exist) == false ]];then
        craine_locals_clones "$craine_locpre" "$preset_random"
    fi

    craine_preset_editor $random_enviro &&
    craine_preset_getenv $random_enviro &&

    craine_remote_clones $preset_remote $preset_locals &&
    craine_locals_movers $preset_random $preset_locals &&
    craine_gitrepo_patch $preset_locals
}

function craine_preset_resets() {

    craine_varname_noval

    local locals_source="$craine_preset/default"
    local target_source="$craine_preset/$craine_name"


    for preset_target in $target_source/*; do

        if [[ -d $preset_target ]];then

            local preset_naming=$(basename "$preset_target")

            notifer_inform "removed preset module $preset_naming"
            rm -fr $preset_target

            notifer_inform "install preset module $preset_naming"
            cp -fr $locals_source/$preset_naming $preset_target
        fi
    done

    notifer_inform "checking remote preset resource"
    craine_gitrepo_pushs $target_source &&
    notifer_inform "preset module reset succesfully"


    unset preset_naming
    unset preset_target
    unset locals_source
    unset target_source
}

function craine_preset_delete() {


    craine_varname_noval
   

    local preset_naming=${craine_name,,}
    local target_source="$craine_preset/$preset_naming"


    craine_vardirs_noval $target_source


    local remote_source=$(cat "$target_source/envi" | grep "preset_repo" | grep -o '"[^"]*"' | sed 's/"//g')


    if [[ -n $remote_source ]];then

        notifer_inform "removing presets data on locals" &&
        for preset_target in $target_source/*; do
            test -d $preset_target && rm -fr $preset_target
        done

        rm $target_source/envi

        notifer_inform "removing presets data at remote" &&
        craine_gitrepo_pushs $target_source
    fi
    
    test -d $target_source && rm -fr $target_source

    unset preset_target
    unset preset_naming
    unset target_source
    unset remote_source
}

function craine_preset_upgrad() {

    for preset_target in $craine_preset/*; do
        if [[ -d $preset_target ]];then

            local preset_naming=$(basename "$preset_target")
            notifer_inform "prepare update $preset_naming preset"
            craine_gitrepo_pulls $preset_target
            notifer_inform "$preset_naming preset already update"
        fi
    done

    unset $preset_target
    unset $preset_naming
}

function craine_preset_purify() {
    echo "preset purify"
}

function craine_preset() {

    if [[ -z $craine_mode ]];then
        notifer_error "Missing operation mode params"   
    fi

    if [[ $craine_mode == "release" ]];then
        craine_preset_catenv
        craine_preset_releas
        craine_preset_purify
    fi

    if [[ $craine_mode == "update" ]];then
        craine_preset_catenv
        craine_preset_update
        craine_preset_purify
    fi

    if [[ $craine_mode == "patch" ]];then
        craine_preset_patchs
    fi

    if [[ $craine_mode == "pull" ]];then
        craine_preset_catenv
        craine_preset_puller
        craine_preset_purify
    fi

    if [[ $craine_mode == "clone" ]];then
        craine_preset_getenv
        craine_preset_clones
        craine_preset_purify
    fi

    if [[ $craine_mode == "reset" ]];then
        craine_preset_catenv
        craine_preset_resets
        craine_preset_purify
    fi

    if [[ $craine_mode == "create" ]];then
        craine_preset_create
    fi

    if [[ $craine_mode == "delete" ]];then
        craine_preset_catenv
        craine_preset_delete
        craine_preset_purify
    fi

    if [[ $craine_mode == "upgrade" ]];then
        craine_preset_catenv
        craine_preset_upgrad
        craine_preset_purify
    fi
}