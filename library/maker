#!/bin/bash


set -e 


## PREPARATION 
function craine_maker_paths() {


    local preset_name=${preset_name,,}

    # raptor target installation
    raptor_rooter="$initdir/$preset_name"
    raptor_makers="$initdir/$preset_name/auxel/makes"
    raptor_resete="$initdir/$preset_name/auxel/resete"
    raptor_config="$initdir/$preset_name/auxel/config"
    raptor_packer="$initdir/$preset_name/auxel/packer/packer"
    raptor_packco="$initdir/$preset_name/auxel/packer/packco"
    raptor_packfa="$initdir/$preset_name/auxel/packer/packfa"


    ## prepare folder information   
    preset_folder="$apppath/preset/default"
    test -d "$apppath/preset/$preset_base" && preset_folder="$apppath/preset/$preset_base"
    test -d "$preset_conf" && preset_folder="$preset_conf"


    ## preaprea default configure
    test -e "$preset_folder/distro.conf" && preset_distro="$preset_folder/distro.conf"
    test -e "$preset_folder/librep.conf" && preset_gitrep="$preset_folder/librep.conf"
    test -e "$preset_folder/instal.conf" && preset_instal="$preset_folder/instal.conf"
  

    ## prepare distro information    
    test -e "$preset_folder/distro.conf" && preset_distro="$preset_folder/distro.conf"
    test -e "$preset_folder/librep.conf" && preset_gitrep="$preset_folder/librep.conf"
    test -e "$preset_folder/instal.conf" && preset_instal="$preset_folder/instal.conf"


    ## prepare distro buidlprofil
    test -d "$apppath/profile" && preset_profil="$apppath/profile"


    ## validation existing config
    if [[ -e "$initdir/$preset_name/auxel/datum/gitrepo.conf" ]]&&[[ -n $preset_gitr ]]&&[[ $inetcon == true ]];then
        read -p "Git repoository preset for $preset_conf is existed, do you want replace it : [ y/N ] " reset_gitrep
    fi

    if [[ -e "$initdir/$preset_name/auxel/datum/raptors.conf" ]];then
        read -p "Distro preset $preset_conf is existed, do you want replace it : [ y/N ] " reset_distro
    fi

    if [[ -e "$initdir/$preset_name/profil/default" ]];then
        read -p "Installation preset $preset_conf is existed, do you want replace it : [ y/N ] " reset_instal
    fi

    if [[ -d "$initdir/$preset_name/profile" ]];then
        read -p "Profile preset $preset_conf is existed, do you want replace it : [ y/N ] " reset_profil
    fi
}


## PREPGITREPO 
function craine_maker_clone() {
    
    git clone $preset_gitr "$initdir/${preset_name,,}"
    
    if [ $? -eq 0 ]; then
        echo "git clone is successful"
    else
        echo "git clone is failed" && exit 1
    fi
}


function craine_maker_pulls() {
    git -C "$initdir/$preset_name" pull origin main
}


function craine_maker_repos() {


    local distro_repos="$initdir/$preset_name/auxel/datum/gitrepo.conf"
    test -e $distro_repos && repodata=$( cat $distro_repos )

   
    ## make new git repository
    if [[ -n $preset_gitr ]]&&[[ -z $repodata ]]&&[[ $inetcon == true ]]; then

       
        test -d "$initdir/$preset_name" && rm -fr "$initdir/$preset_name"
        craine_maker_clone && mkdir -p "$initdir/$preset_name/auxel/datum/" &&
        echo $preset_gitr > $distro_repos 
    

    ## reset git repository
    elif [[ $reset_gitrep == "Y" ]]||[[ $reset_gitrep == "y" ]]&&[[ -n $repodata ]]&&[[ -n $preset_gitr ]]&&[[ $inetcon == true ]]; then
        test -d "$initdir/$preset_name" && rm -fr "$initdir/$preset_name" &&
        craine_maker_clone && mkdir -p "$initdir/$preset_name/auxel/datum/" &&
        echo $preset_gitr > $distro_repos 
        


    ## pull git repodata
    elif [[ -n $repodata ]]&&[[ $inetcon == true ]]; then
        read -p "Do you want to pull remote repository : [ y/N ] " pull_repos

        if [[ $pull_repos == "Y" ]]||[[  $pull_repos == "y" ]];then
            craine_maker_pulls
        fi


    ## create local repodata
    elif [[ -n $preset_gitr ]]&&[[ -z $repodata ]]&&[[ $inetcon == false ]]; then
        mkdir -p "$initdir/$preset_name/auxel/datum/" && touch $distro_repos
        echo $preset_gitr > $distro_repos 
 

    ## create local repodata
    elif [[ -z $preset_gitr ]]&&[[ -z $repodata ]]; then
        mkdir -p "$initdir/$preset_name/auxel/datum/" && touch $distro_repos
        echo $preset_gitr > $distro_repos 
    fi
}


## PREPSYSBASE 
function craine_maker_cores() {
    
    cp -fr "$appcore/"* "$raptor_rooter"  &&
    cp -fr "$appcore/."* "$raptor_rooter" &&
    mkdir -p "$raptor_rooter/"{locals,relpre} &&
    cp -fr "$preset_profil" "$raptor_rooter/distro" &&
    mv "$raptor_rooter/install" "$raptor_rooter/$preset_name-install"
}


function craine_maker_confi() {

    ## ENVIRONTMENT
    local distro_repos="$initdir/$preset_name/auxel/datum/raptors.conf"
    mkdir -p "$initdir/$preset_name/auxel/datum" &&
    cp $preset_distro "$initdir/$preset_name/auxel/datum/prep1" &&
    sed -i '1cdistro_naming="'${preset_name^}'"'  "$initdir/$preset_name/auxel/datum/prep1" &&
    sed -i '2cdistro_unique="'${preset_name,,}'"' "$initdir/$preset_name/auxel/datum/prep1" &&

    sed '/^[[:blank:]]*#/d' "$initdir/$preset_name/auxel/datum/prep1" > "$initdir/$preset_name/auxel/datum/prep2" &&
    sed '/^[[:space:]]*$/d' "$initdir/$preset_name/auxel/datum/prep2" > $distro_repos &&

    rm "$initdir/$preset_name/auxel/datum/prep1" &&
    rm "$initdir/$preset_name/auxel/datum/prep2"
}


function craine_maker_relea() {

  
    local osrelease="$initdir/$preset_name/auxel/release"
    source "$initdir/$preset_name/auxel/datum/raptors.conf"
 

    if [[ ! -z "$distro_naming" ]];then
        echo 'NAME="'$distro_naming'"' > $osrelease
        echo 'PRETTY_NAME="'$distro_naming'"' >> $osrelease
    else
        echo 'NAME="Falcone OS"' > $osrelease
        echo 'PRETTY_NAME="Falcone OS"' >> $osrelease
    fi

    if [[ ! -z "$distro_unique" ]];then
        echo 'ID='$distro_unique'' >> $osrelease
    else
        echo 'ID=falcone' >> $osrelease
    fi

    echo 'ANSI_COLOR="38;2;23;147;209"' >> $osrelease

    if [[ -z "$distro_websit" ]];then
        echo 'HOME_URL="https://'$distro_unique'.yuros.org"' >> $osrelease
        
    else
        echo 'HOME_URL="'$distro_websit'"' >> $osrelease
    fi

    if [[ -z "$distro_docuse" ]];then
        echo 'DOCUMENTATION_URL="https://'$distro_unique'.yuros.org/docs"' >> $osrelease
    else
       echo 'DOCUMENTATION_URL="'$distro_docuse'"' >> $osrelease
    fi

    if [[ -z "$distro_forums" ]];then
        echo 'SUPPORT_URL="https://'$distro_unique'.yuros.org/forum"' >> $osrelease
    else
       echo 'SUPPORT_URL="'$distro_forums'"' >> $osrelease
    fi

    if [[ -z "$distro_report" ]];then
        echo 'BUG_REPORT_URL="https://'$distro_unique'.yuros.org/issues"' >> $osrelease
    else
       echo 'BUG_REPORT_URL="'$distro_report'"' >> $osrelease
    fi

    if [[ -z "$distro_privac" ]];then
        echo 'PRIVACY_POLICY_URL="https://'$distro_unique'.yuros.org/privacy"' >> $osrelease
    else
       echo 'PRIVACY_POLICY_URL="'$distro_privac'"' >> $osrelease
    fi

    if [[ ! -z "$distro_brands" ]];then
        echo 'LOGO='$distro_unique'-linux' >> $osrelease
    else
       echo 'LOGO=falcone-linux' >> $osrelease
    fi

    cat $osrelease > "$initdir/$preset_name/auxel/config/usr/lib/os-release"
    cat $osrelease > "$initdir/$preset_name/distro/airootfs/etc/os-release"
    rm  $osrelease
}


function craine_maker_genis() {

    sleep 1 &&

    local search_string="OSNAMEOS"
    local distro_string="$distro_naming"
    local geniso_gruber="$initdir/$preset_name/distro/grub"
    local geniso_syslin="$initdir/$preset_name/distro/syslinux"
    local geniso_efibot="$initdir/$preset_name/distro/efiboot/loader/entries"
    

    sed -i "s/$search_string/$distro_string/g" "$geniso_syslin/"*.cfg
    sed -i "s/$search_string/$distro_string/g" "$geniso_gruber/"*.cfg
    sed -i "s/$search_string/$distro_string/g" "$geniso_efibot/"*.conf


    sed -i "s/osnameid/$distro_unique/g" "$initdir/$preset_name/distro/profiledef.sh"
    sed -i "s/$search_string/$distro_string/g" "$initdir/$preset_name/distro/profiledef.sh"   
}


function craine_maker_envir() {
    source "$applibs/libkern/load" &&
    source "$applibs/libboot/load" &&
    source "$applibs/libdisk/load" &&
    source "$applibs/libnets/load" &&
    source "$applibs/libaudi/load" &&
    source "$applibs/libguis/load" &&
    source "$applibs/libsecs/load" &&
    source "$applibs/libcore/load" &&
    source "$applibs/libhids/load" &&
    source "$preset_folder/loader" &&
}


function craine_maker_based() {

    local distro_repos="$initdir/$preset_name/auxel/datum/raptors.conf"

    if [[ $reset_distro == "Y" ]]||[[ $reset_distro == "y" ]]; then
        rm -f $distro_repos && touch $distro_repos &&
        craine_maker_cores &&
        craine_maker_confi &&
        craine_maker_relea &&
        craine_maker_genis &&
        craine_maker_envir 
    fi

    if [[ ! -e $distro_repos ]]; then
        craine_maker_cores &&
        craine_maker_confi &&
        craine_maker_relea &&
        craine_maker_genis &&
        craine_maker_envir 
    fi
}


## PREPSYSBASE 
function craine_maker_preps() {
    craine_write_prepmake $kernel_path
    craine_write_prepmake $booter_path
    echo $booter_path 
}


function craine_maker_posts() {
    craine_write_postmake $kernel_path
    craine_write_postmake $booter_path
    
}


function craine_maker_done() {
    cd "$initdir/$ospath"
    git add . &&
    git commit -m "$(date)" &&
    git push
}


function craine_maker_proc() {
    craine_maker_paths
    craine_maker_repos
    craine_maker_based
    craine_maker_preps
    craine_maker_posts
}


function craine_maker() {

    echo "Generate Operating System Builder"

	## OPTIONS PROC
	while getopts ":n:b:g:c" opt; do
		case $opt in
			n) name="${OPTARG}"
			;;
			b) base="${OPTARG}"
			;;
			g) gitr="${OPTARG}"
			;;
            c) conf="${OPTARG}"
			;;
		esac
	done

    preset_conf=$conf
    preset_gitr=$gitr
    preset_name=${name,,}
    preset_base=${base,,}
    test -z $base && preset_base=${name,,}

    craine_maker_proc
}