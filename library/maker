#!/bin/bash


## PRESET PREPARATION 
function craine_maker_prep_gitrepo() {

    if [[ -d "$initdir/$ospath" ]];then

        git -C "$initdir/$ospath" pull origin main

    else
        git clone $preset_gitr "$initdir/$ospath"
        if [ $? -eq 0 ]; then
            echo "git close successful"
        else
            echo "git add failed" && exit 1
        fi
    fi
}


function craine_maker_prep_presets() {

    distro_reset=0
    ospath=${preset_name,,}


    if [[ -e "$initdir/$preset_file/prepare.conf" ]]&&[[ ! -z $preset_file ]]; then
        read -p "preset $preset_file is existed, do you want replace it : [ y/N ] " preset_replace
    fi

    if [[ -e "$initdir/$ospath/prepare.conf" ]]; then
        read -p "preset $ospath is existed, do you want replace it : [ y/N ] " preset_replace
    fi

    if [[ $preset_replace == "Y" ]];then
        distro_reset=1
    fi

    if [[ $preset_replace == "y" ]];then
        distro_reset=1
    fi

    if [[ -e "$initdir/$ospath/prepare.conf" ]]&&[[ $distro_reset == 1 ]];then
        rm -fr "$initdir/$ospath"
    fi


    ## setup distro profile 
    if [[ -z $preset_gitr ]];then
        mkdir -p "$initdir/$ospath/confe"
    else
        craine_maker_prep_gitrepo
    fi


    if [[ -e "$preset_file/distro.conf" ]]; then

        echo "create preset from user defined"
        source "$preset_file/distro.conf"
        cp -f "$preset_file/distro.conf" "$initdir/$ospath/distro.conf"
        cp -f "$preset_file/profil.conf" "$initdir/$ospath/confe/default.conf"

    elif [[ -e "$apppath/preset/$preset_file/distro.conf" ]]; then

        echo "create preset from system available preset"
        source "$apppath/preset/$preset_file/distro.conf"
        cat "$apppath/preset/$preset_file/distro.conf" > "$initdir/$ospath/prepare.conf"
        cp -f "$apppath/preset/$preset_file/profil.conf" "$initdir/$ospath/confe/default.conf"

    elif [[ -e "$apppath/preset/$ospath/distro.conf" ]]; then

        echo "create preset from system available preset"
        source  "$apppath/preset/$ospath/distro.conf"
        cat "$apppath/preset/$ospath/distro.conf" > "$initdir/$ospath/prepare.conf"
        cp -f "$apppath/preset/$ospath/profil.conf" "$initdir/$ospath/confe/default.conf"

    else

        echo "create preset from default system preset"
        source "$apppath/preset/default/distro.conf"
        cp -f "$apppath/preset/default/distro.conf" "$initdir/$ospath/prepare.conf"
        cp -f "$apppath/preset/default/profil.conf" "$initdir/$ospath/confe/default.conf"
    fi


    sed -i '1cdistro_naming="'${preset_name^}'"'  "$initdir/$ospath/prepare.conf"
    sed -i '2cdistro_unique="'${preset_name,,}'"' "$initdir/$ospath/prepare.conf"


    ## cleaned distro preset
    sed '/^[[:blank:]]*#/d' "$initdir/$ospath/prepare.conf" > "$initdir/$ospath/level1.conf"
    sed '/^[[:space:]]*$/d' "$initdir/$ospath/level1.conf" > "$initdir/$ospath/raptor.conf"
    rm -f "$initdir/$ospath/prepare.conf"
    rm -f "$initdir/$ospath/level1.conf"
    

    ## prepare distro preset
    source "$initdir/$ospath/raptor.conf"
}


function craine_maker_prep_profile() {

    if [[ $distro_reset == 0 ]]&&[[ -d "$initdir/$ospath/profile" ]]; then
        return
    fi

    if [[ -d "$initdir/$ospath/distro" ]];then
        rm -fr "$initdir/$ospath/distro"
    fi

    if [[ -d $preset_prof ]]; then

        echo "create profile from user define"
        cp -fr $preset_prof "$initdir/$ospath/distro"

    elif [[ -d "$initdir/$preset_prof/profile" ]]&&[[ ! -z $preset_prof ]]; then

        echo "create profile from available user profile"
        cp -fr "$initdir/$preset_prof/profile" "$initdir/$ospath/distro"

    elif [[ -d "$apppath/profile/$preset_prof" ]]&&[[ ! -z $preset_prof ]]; then

        echo "create profile from available system profile"
        cp -fr "$apppath/profile/$preset_prof" "$initdir/$ospath/distro"

    elif [[ -d "$initdir/$preset_file/profile" ]]&&[[ ! -z $preset_file ]]; then

        echo "create profile from available user profile"
        cp -fr "$initdir/$preset_file/profile" "$initdir/$ospath/distro"

    elif [[ -d "$apppath/profile/$preset_file" ]]&&[[ ! -z $preset_file ]]; then

        echo "create profile from available system profile"
        cp -fr "$apppath/profile/$preset_file" "$initdir/$ospath/distro"

    elif [[ -d "$apppath/profile/$ospath" ]]; then

        echo "create profile from available system profile"
        cp -fr "$apppath/profile/$ospath" "$initdir/$ospath/distro"

    else

        echo "create profile from default system profile"
        cp -fr "$apppath/profile/default" "$initdir/$ospath/distro"

    fi
}


function craine_maker_prep_release() {

    initcfg="$initdir/$ospath/auxel/config"
    initpkg="$initdir/$ospath/auxel/packer/module"
    

    local osrelease="$initdir/$ospath/auxel/release"

    mkdir -p "$initdir/$ospath/"{relpre,locals} &&
    cp -fr "$applibs/installe" "$initdir/$ospath/auxel" &&

    if [[ -e  "$initdir/$ospath/auxel/.gitignore" ]];then
        mv -f "$initdir/$ospath/auxel/.gitignore" "$initdir/$ospath/"
    fi
       
    touch $osrelease

    if [[ ! -z "$distro_naming" ]];then
        echo 'NAME="'$distro_naming'"' > $osrelease
        echo 'PRETTY_NAME="'$distro_naming'"' >> $osrelease
    else
        echo 'NAME="Falcone OS"' > $osrelease
        echo 'PRETTY_NAME="Falcone OS"' >> $osrelease
    fi

    if [[ ! -z "$distro_unique" ]];then
        echo 'ID='$distro_unique'' >> $osrelease
    else
        echo 'ID=falcone' >> $osrelease
    fi

    echo 'ANSI_COLOR="38;2;23;147;209"' >> $osrelease

    if [[ -z "$distro_websit" ]];then
        echo 'HOME_URL="https://'$distro_unique'.yuros.org"' >> $osrelease
        
    else
        echo 'HOME_URL="'$distro_websit'"' >> $osrelease
    fi

    if [[ -z "$distro_docuse" ]];then
        echo 'DOCUMENTATION_URL="https://'$distro_unique'.yuros.org/docs"' >> $osrelease
    else
       echo 'DOCUMENTATION_URL="'$distro_docuse'"' >> $osrelease
    fi

    if [[ -z "$distro_forums" ]];then
        echo 'SUPPORT_URL="https://'$distro_unique'.yuros.org/forum"' >> $osrelease
    else
       echo 'SUPPORT_URL="'$distro_forums'"' >> $osrelease
    fi

    if [[ -z "$distro_report" ]];then
        echo 'BUG_REPORT_URL="https://'$distro_unique'.yuros.org/issues"' >> $osrelease
    else
       echo 'BUG_REPORT_URL="'$distro_report'"' >> $osrelease
    fi

    if [[ -z "$distro_privac" ]];then
        echo 'PRIVACY_POLICY_URL="https://'$distro_unique'.yuros.org/privacy"' >> $osrelease
    else
       echo 'PRIVACY_POLICY_URL="'$distro_privac'"' >> $osrelease
    fi

    if [[ ! -z "$distro_brands" ]];then
        echo 'LOGO='$distro_unique'-linux' >> $osrelease
    else
       echo 'LOGO=falcone-linux' >> $osrelease
    fi

    mkdir -p "$initdir/$ospath/auxel/config/usr/lib/"
    cat $osrelease > "$initdir/$ospath/auxel/config/usr/lib/os-release"
    cat $osrelease > "$initdir/$ospath/distro/airootfs/etc/os-release"
    rm $osrelease


    ## prepare distro builder launcher
    initexe="$initdir/$ospath/$distro_unique"
    initmke="$initdir/$ospath/auxel/makes"
    initres="$initdir/$ospath/auxel/reset"
    if [[ -e "$initdir/$ospath/auxel/install"  ]];then
        mv "$initdir/$ospath/auxel/install" "$initexe"
    fi
}


function craine_maker_prep() {
    craine_maker_prep_presets &&
    craine_maker_prep_profile &&
    craine_maker_prep_release 
}


function craine_maker_envi() {
    source "$applibs/kernels/load"
    source "$applibs/sysbins/load"
    source "$applibs/bootsys/load"
    source "$applibs/audiole/load"
    source "$applibs/desktop/load"
}


function craine_maker_make() {
    craine_write_prepmake $kernel_path
}


function craine_maker_post() {
    craine_write_postmake $kernel_path
}


function craine_maker_done() {
    cd "$initdir/$ospath"
    git add . &&
    git commit -m "$(date)" &&
    git push
}


function craine_maker() {

    echo "Generate Operating System Builder"

	## OPTIONS PROC
	while getopts ":n:f:p:g" opt; do
		case $opt in
			n) name="${OPTARG}"
			;;
			f) file="${OPTARG}"
			;;
			p) prof="${OPTARG}"
			;;
			g) gitr="${OPTARG}"
			;;
		esac
	done

    preset_name=$name
    preset_file=$file
    preset_prof=$prof
    preset_gitr=$gitr

    craine_maker_prep &&
    craine_maker_envi &&
    craine_maker_make &&
    craine_maker_post &&
    craine_maker_done
}