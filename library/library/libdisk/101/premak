
## PREP PARTITION
function raptor_disks_init_pure() {
    local ismounted=$( lsblk -o lsblk -o path,mountpoint | grep "/mnt" )
    if [[ ! -z $ismounted ]];then
        umount -R /mnt > /dev/null 2>&1
    fi
}

## dualboot validator team # @Al Muhdil Karim <karim@yuros.org> @Fawaz Rifqi Frasetia <fras@yuros.org>
function raptor_disks_init_dual() {

    take_efipath=($(lsblk -o path,fstype | grep vfat | awk '{print $1}'))

    for item_efipath in "${take_efipath[@]}"; do

        echo "check efi partition at $item_efipath" 
        sudo mount $item_efipath /srv && sleep 2 && 
       
        if [[ -d "/srv/EFI/Microsoft" ]]; then
            winefipath="$item_efipath" && mkdir -p "$item_efipath/Linux" &&
            echo "check windows efi partition found at $item_efipath"
            dualboot=true
        fi

        sleep 1 && sudo umount -R /srv && sleep 2

    done
}

function raptor_disks_init_swip() {

    if [[ $dualboot == false ]];then

        read -p "Do yout want swipe partition table : [y/N] " swipe_partition_table

        if [[ $swipe_partition_table == "Y" ]]||[[ $swipe_partition_table == "y" ]];then
            sudo parted -s $drivpath mklabel gpt
        fi
    fi
}

function raptor_disks_init() {
    raptor_disks_init_pure
    raptor_disks_init_dual
    raptor_disks_init_swip
}

## MAKE PARTITION
function raptor_disks_make_boot() {

   if [[ -z $( lsblk -o label | grep "BOOT" ) ]]; then
        echo "create boot"
        echo -e "n\np\n\n\n+2G\nt\n\n1\nw" | fdisk "$drivpath" > /dev/null 2>&1
        sleep 2
        bootpath=$(lsblk -o path | grep "$drivpath" | tail -n 1)
        sleep 1
    else
        echo "prepare boot"
        bootpath=$(lsblk -o path,label | grep "BOOT" | awk '{print $1}')
    fi
}

function raptor_disks_make_root() {
    
    if [[ -z $( lsblk -o label | grep "ROOT" ) ]]; then
        echo "create root"
        echo -e "n\np\n\n\n+27G\nw" | fdisk "$drivpath" > /dev/null 2>&1
        sleep 2
        rootpath=$(lsblk -o path | grep "$drivpath" | tail -n 1)
        sleep 1
    else
        echo "prepare root"
        rootpath=$(lsblk -o path,label | grep "ROOT" | awk '{print $1}')
    fi
}

function raptor_disks_make_swap() {
    
    if [[ -z $( lsblk -o path,fstype | grep "swap" ) ]]; then
        echo "create swap"
        echo -e "n\np\n\n\n+4G\nw" | fdisk "$drivpath" > /dev/null 2>&1
        sleep 2
        swappath=$(lsblk -o path | grep "$drivpath" | tail -n 1)
        sleep 1
    else
        echo "prepare swap"
        swappath=$(lsblk -o path,fstype | grep swap | awk '{print $1}' )
    fi
}

function raptor_disks_make_home() {
    
    if [[ -z $( lsblk -o label | grep "HOME" ) ]]; then
        echo "create home"
        echo -e "n\np\n\n\n\nw" | fdisk "$drivpath" > /dev/null 2>&1
        sleep 2
        homepath=$(lsblk -o path | grep "$drivpath" | tail -n 1 )
        sleep 1
    else
        echo "prepare home"
        homepath=$(lsblk -o path,label | grep "HOME" | awk '{print $1}')
    fi
}

function raptor_disks_make() {
    echo "starting auto partitioning"
    raptor_disks_make_boot &&
    raptor_disks_make_root &&
    raptor_disks_make_swap &&
    raptor_disks_make_home
}

## PREV PARTITION
function raptor_disks_prev() {
    
    clear &&
    echo "Storage Information preview"
    echo "--------------------------------"
    echo "boot path : $bootpath"
    echo "root path : $rootpath"
    echo "swap path : $swappath"
    echo "home path : $homepath"
    echo "--------------------------------"
    read -p 'Type "YES" on capital letter to continue or "NO" to abort installation : ' confirmdiskpartition

    if [[ $confirmdiskpartition != "YES" ]];then
        echo "Proccess cancelation by user"
        exit 1
    fi
} 

## FORM PARTITION
function raptor_disks_form_boot() {
    echo "format boot partition"
    mkfs.vfat -F32 -S 4096 -n "BOOT" $bootpath
}

function raptor_disks_form_root() {
    echo "format root partition"
    mkfs.ext4 -F -q -b 4096 -L "ROOT" $rootpath
}

function raptor_disks_form_swap() {
    echo "format swap partition"
    mkswap $swappath
}

function raptor_disks_form_home() {
    if [[ $raptor_procmode != "--reset" ]]; then
        echo "format home partition"
        mkfs.ext4 -F -q -b 4096 -L "HOME" $homepath
    fi
}

function raptor_disks_form() {
    raptor_disks_form_boot
    raptor_disks_form_root
    raptor_disks_form_swap
    raptor_disks_form_home
}

## MONT PARTITION
function raptor_disks_mont_root() {
    echo "mount root partition"
    mount $rootpath /mnt
    mkdir -p /mnt/{home,boot}
}

function raptor_disks_mont_boot() {
    mount -o uid=0,gid=0,dmask=007,fmask=007 $bootpath /mnt/boot
    mkdir -p /mnt/boot/{efi,kernel,loader}
    mkdir -p /mnt/boot/efi/{boot,linux,systemd}

}

function raptor_disks_mont_swap() {
    echo "mount swap partition"
    swapon $swappath
}

function raptor_disks_mont_home() {
    echo "mount home partition"
    mount $homepath /mnt/home
}

function raptor_disks_mont() {
    raptor_disks_mont_root &&
    raptor_disks_mont_boot &&
    raptor_disks_mont_swap &&
    raptor_disks_mont_home
}

function raptor_disks_prep() {

    clear && echo "Partition configuration"
    raptor_disks_init &&
    raptor_disks_make &&
    raptor_disks_prev &&
    raptor_disks_form &&
    raptor_disks_mont &&
    echo "configration done"
}