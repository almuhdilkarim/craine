
function raptor_boots_post_prep() {

    if [[ -e /mnt/boot/amd-ucode.img ]]; then
        echo "clean microcode"
        mv /mnt/boot/amd-ucode.img /mnt/boot/kernel/ 
    fi

    if [[ -e /mnt/boot/intel-ucode.img ]]; then
        echo "clean microcode"
        mv /mnt/boot/intel-ucode.img /mnt/boot/kernel/ 
    fi

    if [[ -e /mnt/boot/vmlinuz-linux-zen ]]; then
        echo "clean vmlinuz"
        mv /mnt/boot/vmlinuz-linux-zen  /mnt/boot/kernel/ 
    fi

    if [[ -e /mnt/boot/vmlinuz-linux-hardened ]]; then
        echo "clean vmlinuz"
        mv /mnt/boot/vmlinuz-linux-hardened  /mnt/boot/kernel/ 
    fi

    if [[ -e /mnt/boot/vmlinuz-linux-lqx ]]; then
        echo "clean vmlinuz"
        mv /mnt/boot/vmlinuz-linux-lqx  /mnt/boot/kernel/ 
    fi

    if [[ -e /mnt/boot/vmlinuz-linux-lts ]]; then
        echo "clean vmlinuz"
        mv /mnt/boot/vmlinuz-linux-lts  /mnt/boot/kernel/ 
    fi

    echo "clean initramfs"
    test -e /mnt/boot/initramfs*  && rm -f /mnt/boot/initramfs*
}


## boot loader @al muhdil karim <karim@yuros.org>, @achmad baihaqi <achmad@yuros.org>, @ibnu dzaky <dzaky@yuros.org>
function raptor_boots_post_init() {
    echo "kernel parameter boot configuration"
    echo "root=$rootpath" > /mnt/etc/cmdline.d/01-boot.conf && 
    echo "installation systemd boot"

    if [[ $dualboot == true ]];then
        #bootctl --esp-path=/mnt/boot/efi --boot-path=/mnt/boot/ install
        mv -f /boot/efi/EFI/Microsoft/Boot/bootmgfw.efi /boot/efi/EFI/Microsoft/Boot/bootmgfw.efi.bak &&
        cp /boot/efi/EFI/systemd/systemd-bootx64.efi /boot/efi/EFI/Microsoft/Boot/bootmgfw.efi
        bootctl --path=/mnt/boot/efi install
    else
        rm -fr /boot/efi/loader &&
        bootctl --path=/mnt/boot install
    fi
}


## secure boot @al muhdil karim <karim@yuros.org>, @muhmmad haydar kamil <kamil@yuros.org>, @sultan fajar ramadhan <sultan@yuros.org>
function raptor_boots_post_secs_dual () {
    echo "setup secure boot for dual boot"
    sbctl create-keys &&
    sbctl sign --save /boot/efi/EFI/Boot/bootx64.efi &&
    sbctl sign --save /boot/efi/EFI/systemd/systemd-bootx64.efi &&
    for efi in /boot/efi/EFI/linux/*; do
        sbctl sign --save /boot/efi/EFI/linux/$efi
    done

    for vml in /boot/kernel/vmlinuz*; do
        sbctl sign --save /boot/kernel/$vml
    done
    sbctl enroll-keys -m -i &&
    sbctl verify | sed -E 's|^.* (/.+) is not signed$|sbctl sign -s "\1"|e'
}

function raptor_boots_post_secs_mono () {
    echo "setup secure boot for mono boot"
    sbctl create-keys &&
    sbctl sign --save /boot/efi/boot/bootx64.efi &&
    sbctl sign --save /boot/efi/systemd/systemd-bootx64.efi &&
    for efi in /boot/efi/linux/*; do
        sbctl sign --save /boot/efi/EFI/linux/$efi
    done
    for vml in /boot/kernel/vmlinuz*; do
        sbctl sign --save /boot/kernel/$vml
    done
}

function raptor_boots_post_secs() {
    if [[ $dualboot == true ]];then
        raptor_boots_post_secs_dual
    else
        raptor_boots_post_secs_mono
    fi
}

function raptor_boots_post() {
    sleep 2 && clear
    echo "Booting module configuration"
    raptor_boots_post_prep
    raptor_boots_post_init
    raptor_boots_post_secs
}